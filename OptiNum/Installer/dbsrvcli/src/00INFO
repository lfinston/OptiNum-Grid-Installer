%% 00INFO
%% Created by Laurence D. Finston (LDF) Tue Oct  6 09:08:07 CEST 2009

%% Copyright (C) 2009, 2010, 2011 Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH

%% $Id: 00INFO 673 2009-12-04 10:14:56Z lfinsto $


%% ** (2) PGP Public Key for `optinum_installer':  opinpbky.asc

LDF 2011.11.10.  

Added to distribution.

%% ** (2) For Michaela:  Invocation on pcmohr

LDF 2011.10.31.

./optdbcli_1 --input-filename="test_input.txt" \
--ca-filename=DFN-VereinPCAGrid-G01.pem  \
--cert-filename=/home/mmohr1/Save/SaveCerts/CertAuthDfn.2011.08.17/usercert.pem \
--key-filename=/home/mmohr1/Save/SaveCerts/CertAuthDfn.2011.08.17/userkey_npwd.pem optinum-srv.gwdg.de \
optinum-srv.gwdg.de

From command line without input file:

echo "show entries user with_installation_script" | ./optdbcli_1 --ca-filename=DFN-VereinPCAGrid-G01.pem \
--cert-filename=/home/mmohr1/Save/SaveCerts/CertAuthDfn.2011.08.17/usercert.pem \
--key-filename=/home/mmohr1/Save/SaveCerts/CertAuthDfn.2011.08.17/userkey_npwd.pem \
optinum-srv.gwdg.de

%% ** (2) New certificates

LDF 2011.09.26.

Replacing usercert.pem, userkey.pem and usercert.txt.  These files are for my
private used and not checked into the SVN repository!

I've saved the old files in ~/certificates/.

%% ** (2) "Magic" Version number

LDF 2011.08.10.

-1 is a "magic" version number.  That is, it is used internally for packages that 
don't have a version number.  This became necessary because of a problem when trying 
to use "secure installation" to install packages without version numbers.

If -1 turns out to be a poor choice, code will need to be changed in 
|Entry_Type::operator==(const Entry_Type e)| in `entries.web',
the `statement: SERVER_ZZ SENDING_ZZ ...' rules for encrypted entries in 
`prsrclnt.web' and the various `Scan_Parse_Parameter_Type::fetch_*' functions in 
`scprpmtp.web'.

The problem could also be solved by changing the order in which items are placed onto 
|entry_string_list| in `prsrclnt.web'.  The package version could be placed last.  
However, this would be somewhat inconvenient, so I'm leaving things as they are, 
for the present.

!! TODO:  Do something about this.

%% ** (2) Secure installation

LDF 2011.08.10.

This is one way of testing it:

#### Create encrypted files (download info, installation script and authorization)

prpencfs.sh hello 2.7 8F2F8230 \
   "/C=DE/O=GridGermany/OU=Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH/CN=Laurence Finston" \
   dwnl_url.txt inst_scrpt.sh 

make run-d # Delete all old entries.  This is the drastic approach.  
           # Normally, it should not be necessary to delete all entries.
           # It is useful when testing the use (or non-use) of version numbers.

make run-c # Create a new entry.

make run-h # Display the new entry.

#### Install the package, not giving a version number.

make optdbcli_1 && optdbcli_1 --package-name=hello --proxy-cert x509up_u1000 \
     --reinstall --install-dir=/home/lfinsto/aaa localhost 

#### Install the package, giving a version number.

make optdbcli_1 && optdbcli_1 --package-name=hello --package-version=2.7 \
     --proxy-cert x509up_u1000 --reinstall \
     --install-dir=/home/lfinsto/aaa localhost 


%% ** (2) GPG 

LDF 2011.05.19.

RSA Key types (found on GPG mailing list)

Certification  == signing someone's key
Signing        == signing some data (e.g. a file)
Encryption     == encrypting some data
Authentication == signing a challenge to indicate you are who you say
		  you are


From http://tools.ietf.org/html/rfc4880

RFC 4880                 OpenPGP Message Format            November 2007


       First octet:

       0x01 - This key may be used to certify other keys.

       0x02 - This key may be used to sign data.

       0x04 - This key may be used to encrypt communications.

       0x08 - This key may be used to encrypt storage.

       0x10 - The private component of this key may have been split
              by a secret-sharing mechanism.

       0x20 - This key may be used for authentication.

       0x80 - The private component of this key may be in the
              possession of more than one person.


%% ** (2)

LDF 2011.05.19.

I am now using '' (instead of "") for the argument to `echo', except where
shell expansion is desired (default installation script).  However, I think
there's a place where special characters are replaced, but I couldn't find it,
even though I searched thoroughly.  However, this isn't urgent.  I think the
text that's checked is generated by gpg -a anyway, so it won't contain any
characters that need to be escaped.  I may actually have deleted it.

%% ** (2) 

LDF 2011.04.21.

Removed this comment from `prsrfncs.web', because encryption is no longer
performed.  However, I want to keep the comment, because it contains useful 
information.

The -a option (a.k.a. --armor) to gpg --encrypt writes the output in PEM 
(``Privacy-enhanced Mail'') format.  See 
http://en.wikipedia.org/wiki/Base64\#Privacy-enhanced\_mail 
for more information.  The main point with respect to this package is that single quotes 
are not used in the encoding, so that there should be no problem writing data in this format 
to the MySQL database.

%% ** (2) 

LDF 2011.04.13.

hostcert.pem and hostkey.pem are copies of usercert.pem and userkey.pem, respectively.

%% ** (2) 

LDF 2010.07.22.

On pcfinston:

optdbsrv must be called like this:

optdbsrv --grid-mapfile grid-mapfile

It currently doesn't work to link with the development branch (`master') of
gnutls.  This seems to have something to do with the environment variables 
`LD_LIBRARY_PATH', `CXXFLAGS' and `LDFLAGS'.

%% ** (2) Effective User DN

LDF 2010.06.30.

Using these commands for testing:

echo "delete from Entries where package_name = 'sundials'" | mysql dbsrvcli && make optdbcli_1 && optdbcli_1 --effective-user-dn "/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Michaela Mohr" --input test_input.txt localhost

echo "select * from Entries where package_name = 'sundials'" | mysql --vertical dbsrvcli 


%% ** (2) 

LDF 2010.05.20.

Using these for server:

/etc/grid-security:

hostcert.pem
hostkey.pem

%% ** (2) Printing out certificate info

LDF 2010.04.22.

Globus environment must be set for this to work (GLOBUS_LOCATION setting 
and scripts)

Code for doing this is in `~/.bash_profile'.  It's currently commented-out.

grid-cert-info -subject -f <path to certificate file>

%% ** (2) grid-mapfile

LDF 2010.04.21.

The grid-mapfile (for Globus Toolkit) is:

/etc/grid-security/grid-mapfile

%% ** (2) Invoking the server and the client

%% *** (3)

LDF 2010.04.30.

Server on optinum-srv.gwdg.de, client on rocks:

Start server on optinum-srv:

Start client on rocks:

Authorized/Authenticated connection (with X.509 certificate):

/opt/optinum/dbsrvcli/bin/optdbcli --input=test_input.txt optinum-srv.local 


Non-Authorized 

/opt/optinum/dbsrvcli/bin/optdbcli --non-auth --no-read --fetch --package-name="m4" \
--dn="/C=DE/O=GridGermany/OU=Gesellschaft fuer \
wissenschaftliche Datenverarbeitung mbH/OU=Gesellschaft fuer \
wissenschaftliche Datenverarbeitung mbH/CN=Laurence Finston" \
optinum-srv.local 



%% *** (3)

LDF 2010.04.22.

Server can be started like this:

make optdbsrv && optdbsrv --grid-mapfile grid-mapfile 

Client can be started like this:

make optdbcli && optdbcli --non-auth --no-read --fetch --package-name="m4" \
--dn="/C=DE/O=GridGermany/OU=Gesellschaft fuer wissenschaftliche \
Datenverarbeitung mbH/OU=Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH/CN=Laurence Finston" \
localhost

 --non-auth --no-read --fetch --package-name="m4" --dn="/C=DE/O=GridGermany/OU=Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH/OU=Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH/CN=Laurence Finston" 


%% *** (3) Calling client like this to test handling of prerequisites.

rm -rf ~/installer_work/ ~/Installer/

echo "delete from Entries where user_id = 1" \
| mysql --user=lfinsto dbsrvcli && \
echo "delete from Prerequisites" | mysql --user=lfinsto dbsrvcli && \
make optdbcli && optdbcli --input test_input.txt localhost 

make optdbcli && optdbcli --input test_input.txt localhost 

LDF 2010.02.26.

echo "delete from Entries where package_name = 'GNU hello' and user_id = 1" \
| mysql --user=lfinsto dbsrvcli && make optdbcli && optdbcli --input test_input.txt localhost 

%% *** (3) Other ways of calling the server

./optdbsrv \
--key-filename="/home/mmohr1/Save/SaveCerts/CertAuthDfnDbsrvcli/userkey.pem" \
--cert-filename="/home/mmohr1/Save/SaveCerts/CertAuthDfnDbsrvcli/usercert.pem"

%% *** (3) Various other ways of starting the client

make optdbcli && optdbcli --non-auth --no-read --fetch --package-name="m4" \
--dn="/C=DE/O=GridGermany/OU=Gesellschaft fuer wissenschaftliche \
Datenverarbeitung mbH/OU=Gesellschaft fuer wissenschaftliche Datenverarbeitung mbH/CN=Laurence Finston" \
localhost

./optdbcli --non-auth --no-read --install \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Michaela Mohr" \
localhost 

make optdbcli && optdbcli --non-auth --no-read --fetch --package-name="GNU hello" --package-version="2.5" \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" \
localhost

optdbcli --non-auth --no-read --fetch --package-name="GNU hello" --package-version="2.5" --dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" localhost

or

make optdbcli && optdbcli --non-auth --no-read --install --package-name="GNU hello" --package-version="2.5" \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" \
localhost

or

./optdbcli --non-auth --no-read --install --fetch \
--package-name=bison --package-version=1.0 \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Michaela Mohr" pcmohr

or

make optdbcli && optdbcli --non-auth --no-read --install --package-name="GNU hello" --package-version="2.5" --dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" localhost 

or

make optdbcli && optdbcli --non-auth --no-read --install --package-name="GNU hello" --package-version --dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" localhost 

or

rm -rf ~/Installer/ ~/installer_work/ \
&& make optdbcli && optdbcli --non-auth --no-read \
--install --package-name="GNU hello" --package-version \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" \
localhost 


or 

make optdbcli && optdbcli --non-auth --no-read \
--fetch --package-name="m4" --package-version \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" \
localhost 

or 

make optdbcli && optdbcli --non-auth --no-read \
--fetch --package-name="3dldf" --package-version="1.2" \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" \
localhost 

or 

make optdbcli && optdbcli --non-auth --no-read --env \
--dn="/O=Grid/OU=GlobusTest/OU=simpleCA-pcmohr.gwdg.de/OU=gwdg.de/CN=Laurence Finston" localhost

%% ** (2) Printing out hexadecimal numbers


This works in the shell:

printf "\n%d\n" 0x100

%% ** (2)

Information about fields in certificate in this file:

x509guide.txt

Copied from GNUTLS distribution.

%% ** (2)

Call `optdbsrv' like this:

optdbsrv

or like this (for example):

optdbsrv --ca-filename=DFN-VereinPCAGrid-G01.pem --key-filename=userkey.pem --cert-filename=usercert.pem

or like this:

make optdbsrv && optdbsrv

Call optdbcli like this:  


make optdbcli && optdbcli --input-filename="test_input.txt" 134.76.5.25

cat test_input.txt | optdbcli 134.76.5.25

or like this:

optdbcli 134.76.5.25 < test_input.txt 

mysql dbsrvcli -e "delete from Entries where entry_id > 0" && make optdbcli && optdbcli --input-filename="test_input.txt" 134.76.5.25

%% ** (2)

!! If |gnutls_gnutls_record_recv| blocks, it can help to send an EOF from the
other side with |gnutls_record_send|.  It is
necessary to make sure that the EOF is handled correctly.

%% ** (2)

scp -p optinum-1.0.tar.gz lfinsto@gwdu101:~/optinum

%% * (1) End of 00INFO

%% ** (2) Using the database

To start the server:

(As root!)

mysqld_safe --user=root --log &

To stop the server:

mysqladmin -u root shutdown

mysql --user=user_name --password=your_password db_name

mysql --user=root --password=""

show databases;

use optinum

show tables;


%% ** (2) `certtest/client_1' and `optdbsrv'

Call like this:

make server_2 && server_2

(In `certtest' subdirectory):

make client_1 && client_1 proxy_plus_certs.pem privkey.pem 

(For example)

%% ** (2) 

Use diff like this:

diff -u <old file> <new file>

-Naur (for directories)

%% ** (2) @>

Simple CA certificate used by Michaela:

mmohr1/.globus/certificates/




%% * (1) Local Variables for Emacs 

%% Local Variables: 
%% eval:(display-time) 
%% abbrev-mode:t
%% eval:(read-abbrev-file) 
%% indent-tabs-mode:nil 
%% eval:(outline-minor-mode) 
%% outline-regexp:"%% *\\*+" 
%% End: 

%% * (1) End of 00INFO
